name: Deploy Staging

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-staging-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ì„¤ì¹˜ í™•ì¸
        run: |
          node --version
          pnpm --version
          echo "í™˜ê²½ ì„¤ì • ì™„ë£Œ"

  build-staging:
    name: Staging ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: setup
    env:
      NEXT_PUBLIC_ENV: staging
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ ì „)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ ì „) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ì¡´ì¬"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
          else
            echo "âœ— .turbo ë””ë ‰í† ë¦¬ ì—†ìŒ (ì²« ì‹¤í–‰)"
          fi
          echo "=================================="

      - name: Staging í™˜ê²½ ë¹Œë“œ
        run: pnpm turbo build
        env:
          NEXT_PUBLIC_ENV: staging

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ í›„)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ í›„) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
            echo "ìºì‹œ í¬ê¸°: $(du -sh .turbo 2>/dev/null || echo 'N/A')"
          fi
          echo "=================================="

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦
        run: |
          echo "ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦ ì¤‘..."
          if [ -d "apps/web/.next" ]; then
            echo "âœ“ Web ì•± ë¹Œë“œ ì„±ê³µ"
          else
            echo "âœ— Web ì•± ë¹Œë“œ ì‹¤íŒ¨"
            exit 1
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: staging-build
          path: |
            apps/web/.next
            apps/web/public
            apps/web/package.json
          retention-days: 7

  build-docker-image:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: build-staging
    permissions:
      contents: read
      packages: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/workly-web
          tags: |
            type=raw,value=staging
            type=sha,prefix=staging-

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_ENV=staging

      - name: ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
          echo "Registry: ghcr.io"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  deploy-staging:
    name: Staging ì„œë²„ ë°°í¬
    runs-on: ubuntu-latest
    needs: build-docker-image
    environment:
      name: staging
      url: https://staging.worklyteam.cloud
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VULTR_WEB_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VULTR_WEB_HOST }} >> ~/.ssh/known_hosts

      - name: ë°°í¬ íŒŒì¼ ì „ì†¡
        run: |
          scp -r deployment/web/* root@${{ secrets.VULTR_WEB_HOST }}:/opt/workly/deployment/web/
          scp deployment/scripts/* root@${{ secrets.VULTR_WEB_HOST }}:/opt/workly/scripts/

      - name: Docker ì´ë¯¸ì§€ í’€ ë° ë°°í¬
        run: |
          ssh root@${{ secrets.VULTR_WEB_HOST }} << 'EOF'
            cd /opt/workly/deployment/web
            
            # GitHub Container Registry ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export DOCKER_IMAGE="ghcr.io/${{ github.repository }}/workly-web:staging"
            export DEPLOY_ENV="staging"
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            bash scripts/deploy-sequential.sh
          EOF

      - name: ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸš€ Staging ë°°í¬ ì™„ë£Œ!"
          echo "URL: https://staging.worklyteam.cloud"

  verify-staging:
    name: Staging ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: ë°°í¬ ì„±ê³µ í™•ì¸
        run: |
          echo "âœ“ Staging ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ë°°í¬ í™˜ê²½: staging"

      - name: í—¬ìŠ¤ ì²´í¬ (ì„ íƒì‚¬í•­)
        run: |
          echo "í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ..."
          # ì‹¤ì œ í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì„œ í˜¸ì¶œ
          # curl -f https://staging.workly.app/api/health || exit 1
          echo "âœ“ í—¬ìŠ¤ ì²´í¬ í†µê³¼ (êµ¬í˜„ ì‹œ í™œì„±í™”)"

  notify-failure:
    name: ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [build-staging, deploy-staging, verify-staging]
    if: failure()
    steps:
      - name: ì‹¤íŒ¨ ì •ë³´ ìˆ˜ì§‘
        id: failure-info
        run: |
          echo "WORKFLOW_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT || echo "COMMIT_MESSAGE=N/A" >> $GITHUB_OUTPUT

      - name: GitHub ì•Œë¦¼ (ê¸°ë³¸)
        run: |
          echo "::error::Staging ë°°í¬ ì‹¤íŒ¨"
          echo "ì›Œí¬í”Œë¡œìš°: ${{ steps.failure-info.outputs.WORKFLOW_URL }}"
          echo "ì»¤ë°‹: ${{ steps.failure-info.outputs.COMMIT_SHA }}"

      # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­ - SLACK_WEBHOOK_URL secret ì„¤ì • ì‹œ í™œì„±í™”)
      - name: Slack ì•Œë¦¼
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "ğŸš¨ Staging ë°°í¬ ì‹¤íŒ¨",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Staging ë°°í¬ ì‹¤íŒ¨*\nì›Œí¬í”Œë¡œìš°: <${{ steps.failure-info.outputs.WORKFLOW_URL }}|ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°>\nì»¤ë°‹: `${{ steps.failure-info.outputs.COMMIT_SHA }}`\ní™˜ê²½: Staging"
                  }
                }
              ]
            }
