name: Deploy Staging

on:
  push:
    branches:
      - main
    paths:
      - 'apps/web/**'
      - 'apps/admin/**'
      - 'packages/**'
      - '.github/workflows/deploy-staging.yml'
  workflow_dispatch:
    inputs:
      app:
        description: '배포할 앱'
        required: true
        type: choice
        options:
          - web
          - admin
          - both
        default: 'both'

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  detect-changes:
    name: 변경 감지
    runs-on: ubuntu-latest
    outputs:
      web-changed: ${{ steps.changes.outputs.web }}
      admin-changed: ${{ steps.changes.outputs.admin }}
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: 변경된 파일 필터링
        if: github.event_name == 'push'
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            web:
              - 'apps/web/**'
              - 'packages/**'
            admin:
              - 'apps/admin/**'
              - 'packages/**'

      - name: 변경 감지 결과 설정
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # 수동 트리거: 선택한 앱 배포
            if [ "${{ github.event.inputs.app }}" = "web" ] || [ "${{ github.event.inputs.app }}" = "both" ]; then
              echo "web=true" >> $GITHUB_OUTPUT
            else
              echo "web=false" >> $GITHUB_OUTPUT
            fi
            
            if [ "${{ github.event.inputs.app }}" = "admin" ] || [ "${{ github.event.inputs.app }}" = "both" ]; then
              echo "admin=true" >> $GITHUB_OUTPUT
            else
              echo "admin=false" >> $GITHUB_OUTPUT
            fi
          else
            # 자동 트리거: 변경 감지 결과 사용
            echo "web=${{ steps.filter.outputs.web }}" >> $GITHUB_OUTPUT
            echo "admin=${{ steps.filter.outputs.admin }}" >> $GITHUB_OUTPUT
          fi

  build-web:
    name: Web 앱 빌드
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web-changed == 'true'
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 및 의존성 설정
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Web 앱 빌드
        run: pnpm turbo build --filter=@workly/web
        env:
          NEXT_PUBLIC_ENV: staging
          NEXT_PUBLIC_API_URL: ${{ vars.WEB_STAGING_API_URL }}
          NEXT_PUBLIC_API2_URL: ${{ vars.WEB_STAGING_ADMIN_API_URL }}

      - name: GitHub Container Registry 로그인
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Docker 이미지 빌드 및 푸시 (Blue)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:blue
          build-args: |
            NEXT_PUBLIC_ENV=staging
            NEXT_PUBLIC_API_URL=${{ vars.WEB_STAGING_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.WEB_STAGING_ADMIN_API_URL }}

      - name: Docker 이미지 빌드 및 푸시 (Green)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:green
          build-args: |
            NEXT_PUBLIC_ENV=staging
            NEXT_PUBLIC_API_URL=${{ vars.WEB_STAGING_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.WEB_STAGING_ADMIN_API_URL }}

  build-admin:
    name: Admin 앱 빌드
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-changed == 'true'
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: Node.js 및 의존성 설정
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Admin 앱 빌드
        run: pnpm turbo build --filter=@workly/admin
        env:
          NEXT_PUBLIC_ENV: staging
          NEXT_PUBLIC_API_URL: ${{ vars.ADMIN_STAGING_API_URL }}
          NEXT_PUBLIC_API2_URL: ${{ vars.ADMIN_STAGING_ADMIN_API_URL }}

      - name: GitHub Container Registry 로그인
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Docker 이미지 빌드 및 푸시 (Blue)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/admin/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:admin-blue
          build-args: |
            NEXT_PUBLIC_ENV=staging
            NEXT_PUBLIC_API_URL=${{ vars.ADMIN_STAGING_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.ADMIN_STAGING_ADMIN_API_URL }}

      - name: Docker 이미지 빌드 및 푸시 (Green)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/admin/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:admin-green
          build-args: |
            NEXT_PUBLIC_ENV=staging
            NEXT_PUBLIC_API_URL=${{ vars.ADMIN_STAGING_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.ADMIN_STAGING_ADMIN_API_URL }}

  deploy-web-staging:
    name: Web Staging 배포
    runs-on: ubuntu-latest
    needs: build-web
    environment:
      name: web-staging
      url: https://${{ vars.WEB_STAGING_DOMAIN }}
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: SSH 키 설정
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.WEB_STAGING_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.WEB_STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: 배포 파일 전송
        run: |
          scp -r deployment/web/* root@${{ secrets.WEB_STAGING_HOST }}:/opt/workly/deployment/web/
          scp deployment/scripts/* root@${{ secrets.WEB_STAGING_HOST }}:/opt/workly/scripts/

      - name: Docker 이미지 풀 및 배포
        run: |
          ssh root@${{ secrets.WEB_STAGING_HOST }} << 'EOF'
            cd /opt/workly/deployment/web
            
            # GitHub Container Registry 로그인
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 환경 변수 설정
            export GITHUB_REPOSITORY="${{ vars.REPOSITORY_NAME }}"
            export DEPLOY_ENV="staging"
            export NEXT_PUBLIC_API_URL="${{ vars.WEB_STAGING_API_URL }}"
            
            # 배포 스크립트 실행
            bash scripts/deploy-sequential.sh
          EOF

      - name: 헬스 체크
        run: |
          echo "헬스 체크 엔드포인트 호출..."
          HEALTH_URL="https://${{ vars.WEB_STAGING_DOMAIN }}/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "헬스 체크 시도 $i/$MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ 헬스 체크 통과"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "재시도 대기 중... (${RETRY_DELAY}초)"
              sleep $RETRY_DELAY
            fi
          done
          echo "⚠️ 헬스 체크 실패 - 수동 확인 필요"
          exit 1

  deploy-admin-staging:
    name: Admin Staging 배포
    runs-on: ubuntu-latest
    needs: build-admin
    environment:
      name: admin-staging
      url: https://${{ vars.ADMIN_STAGING_DOMAIN }}
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4

      - name: SSH 키 설정
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ADMIN_STAGING_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ADMIN_STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: 배포 파일 전송
        run: |
          scp -r deployment/admin/* root@${{ secrets.ADMIN_STAGING_HOST }}:/opt/workly/deployment/admin/
          scp deployment/scripts/* root@${{ secrets.ADMIN_STAGING_HOST }}:/opt/workly/scripts/

      - name: Docker 이미지 풀 및 배포
        run: |
          ssh root@${{ secrets.ADMIN_STAGING_HOST }} << 'EOF'
            cd /opt/workly/deployment/admin
            
            # GitHub Container Registry 로그인
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 환경 변수 설정
            export GITHUB_REPOSITORY="${{ vars.REPOSITORY_NAME }}"
            export DEPLOY_ENV="staging"
            export NEXT_PUBLIC_API_URL="${{ vars.ADMIN_STAGING_API_URL }}"
            
            # 배포 스크립트 실행
            bash scripts/deploy-sequential.sh
          EOF

      - name: 헬스 체크
        run: |
          echo "헬스 체크 엔드포인트 호출..."
          HEALTH_URL="https://${{ vars.ADMIN_STAGING_DOMAIN }}/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "헬스 체크 시도 $i/$MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ 헬스 체크 통과"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "재시도 대기 중... (${RETRY_DELAY}초)"
              sleep $RETRY_DELAY
            fi
          done
          echo "⚠️ 헬스 체크 실패 - 수동 확인 필요"
          exit 1
