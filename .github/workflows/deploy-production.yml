name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬ ë²„ì „ (ì„ íƒì‚¬í•­)'
        required: false
        type: string
        default: 'latest'
      rollback:
        description: 'ë¡¤ë°± ëª¨ë“œ í™œì„±í™”'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (ê¸´ê¸‰ ë°°í¬ìš©)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  setup:
    name: í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ì„¤ì¹˜ í™•ì¸
        run: |
          node --version
          pnpm --version
          echo "í™˜ê²½ ì„¤ì • ì™„ë£Œ"
          echo "ë°°í¬ ë²„ì „: ${{ github.event.inputs.version }}"
          echo "ë¡¤ë°± ëª¨ë“œ: ${{ github.event.inputs.rollback }}"

  build-production:
    name: Production ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: setup
    env:
      NEXT_PUBLIC_ENV: production
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ ì „)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ ì „) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ì¡´ì¬"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
          else
            echo "âœ— .turbo ë””ë ‰í† ë¦¬ ì—†ìŒ (ì²« ì‹¤í–‰)"
          fi
          echo "=================================="

      - name: Production í™˜ê²½ ë¹Œë“œ
        run: pnpm turbo build
        env:
          NEXT_PUBLIC_ENV: production

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ í›„)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ í›„) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
            echo "ìºì‹œ í¬ê¸°: $(du -sh .turbo 2>/dev/null || echo 'N/A')"
          fi
          echo "=================================="

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦
        run: |
          echo "ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦ ì¤‘..."
          if [ -d "apps/web/.next" ]; then
            echo "âœ“ Web ì•± ë¹Œë“œ ì„±ê³µ"
          else
            echo "âœ— Web ì•± ë¹Œë“œ ì‹¤íŒ¨"
            exit 1
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            apps/web/.next
            apps/web/public
            apps/web/package.json
          retention-days: 30

  detect-changes:
    name: ë³€ê²½ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      web-changed: ${{ steps.check.outputs.web }}
      admin-changed: ${{ steps.check.outputs.admin }}
    steps:
      - name: ë³€ê²½ í™•ì¸
        id: check
        run: |
          echo "web=true" >> $GITHUB_OUTPUT
          echo "admin=true" >> $GITHUB_OUTPUT

  build-web-docker:
    name: Web Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [build-production, detect-changes]
    if: needs.detect-changes.outputs.web-changed == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (Blue)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:blue
          build-args: |
            NEXT_PUBLIC_ENV=production
            NEXT_PUBLIC_API_URL=${{ vars.WEB_PRODUCTION_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.WEB_PRODUCTION_ADMIN_API_URL }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (Green)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:green
          build-args: |
            NEXT_PUBLIC_ENV=production
            NEXT_PUBLIC_API_URL=${{ vars.WEB_PRODUCTION_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.WEB_PRODUCTION_ADMIN_API_URL }}

  build-admin-docker:
    name: Admin Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: [build-production, detect-changes]
    if: needs.detect-changes.outputs.admin-changed == 'true'
    permissions:
      contents: read
      packages: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (Blue)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/admin/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:admin-blue
          build-args: |
            NEXT_PUBLIC_ENV=production
            NEXT_PUBLIC_API_URL=${{ vars.ADMIN_PRODUCTION_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.ADMIN_PRODUCTION_ADMIN_API_URL }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (Green)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/admin/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ vars.REPOSITORY_NAME }}:admin-green
          build-args: |
            NEXT_PUBLIC_ENV=production
            NEXT_PUBLIC_API_URL=${{ vars.ADMIN_PRODUCTION_API_URL }}
            NEXT_PUBLIC_API2_URL=${{ vars.ADMIN_PRODUCTION_ADMIN_API_URL }}

  deploy-web-production:
    name: Web Production ë°°í¬
    runs-on: ubuntu-latest
    needs: build-web-docker
    environment:
      name: web-production
      url: https://${{ vars.WEB_PRODUCTION_DOMAIN }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¡¤ë°± ëª¨ë“œ í™•ì¸
        if: github.event.inputs.rollback == 'true'
        run: |
          echo "âš ï¸ ë¡¤ë°± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤"

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.WEB_PRODUCTION_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.WEB_PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: ë°°í¬ íŒŒì¼ ì „ì†¡
        if: github.event.inputs.rollback != 'true'
        run: |
          scp -r deployment/web/* root@${{ secrets.WEB_PRODUCTION_HOST }}:/opt/workly/deployment/web/
          scp deployment/scripts/* root@${{ secrets.WEB_PRODUCTION_HOST }}:/opt/workly/scripts/

      - name: Docker ì´ë¯¸ì§€ í’€ ë° ë°°í¬
        if: github.event.inputs.rollback != 'true'
        run: |
          ssh root@${{ secrets.WEB_PRODUCTION_HOST }} << 'EOF'
            cd /opt/workly/deployment/web
            
            # GitHub Container Registry ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export GITHUB_REPOSITORY="${{ vars.REPOSITORY_NAME }}"
            export DEPLOY_ENV="production"
            export NEXT_PUBLIC_API_URL="${{ vars.WEB_PRODUCTION_API_URL }}"
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            bash scripts/deploy-sequential.sh
          EOF

      - name: ë¡¤ë°± ì‹¤í–‰
        if: github.event.inputs.rollback == 'true'
        run: |
          ssh root@${{ secrets.WEB_PRODUCTION_HOST }} << 'EOF'
            cd /opt/workly/deployment/web
            bash /opt/workly/scripts/rollback.sh web
          EOF

      - name: ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸš€ Web Production ë°°í¬ ì™„ë£Œ!"
          echo "URL: https://${{ vars.WEB_PRODUCTION_DOMAIN }}"
          echo "ë°°í¬ ë²„ì „: ${{ github.event.inputs.version }}"

  deploy-admin-production:
    name: Admin Production ë°°í¬
    runs-on: ubuntu-latest
    needs: build-admin-docker
    environment:
      name: admin-production
      url: https://${{ vars.ADMIN_PRODUCTION_DOMAIN }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¡¤ë°± ëª¨ë“œ í™•ì¸
        if: github.event.inputs.rollback == 'true'
        run: |
          echo "âš ï¸ ë¡¤ë°± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤"

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ADMIN_PRODUCTION_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ADMIN_PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: ë°°í¬ íŒŒì¼ ì „ì†¡
        if: github.event.inputs.rollback != 'true'
        run: |
          scp -r deployment/admin/* root@${{ secrets.ADMIN_PRODUCTION_HOST }}:/opt/workly/deployment/admin/
          scp deployment/scripts/* root@${{ secrets.ADMIN_PRODUCTION_HOST }}:/opt/workly/scripts/

      - name: Docker ì´ë¯¸ì§€ í’€ ë° ë°°í¬
        if: github.event.inputs.rollback != 'true'
        run: |
          ssh root@${{ secrets.ADMIN_PRODUCTION_HOST }} << 'EOF'
            cd /opt/workly/deployment/admin
            
            # GitHub Container Registry ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export GITHUB_REPOSITORY="${{ vars.REPOSITORY_NAME }}"
            export DEPLOY_ENV="production"
            export NEXT_PUBLIC_API_URL="${{ vars.ADMIN_PRODUCTION_API_URL }}"
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            bash scripts/deploy-sequential.sh
          EOF

      - name: ë¡¤ë°± ì‹¤í–‰
        if: github.event.inputs.rollback == 'true'
        run: |
          ssh root@${{ secrets.ADMIN_PRODUCTION_HOST }} << 'EOF'
            cd /opt/workly/deployment/admin
            bash /opt/workly/scripts/rollback.sh admin
          EOF

      - name: ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸš€ Admin Production ë°°í¬ ì™„ë£Œ!"
          echo "URL: https://${{ vars.ADMIN_PRODUCTION_DOMAIN }}"
          echo "ë°°í¬ ë²„ì „: ${{ github.event.inputs.version }}"

  verify-web-production:
    name: Web Production ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy-web-production
    steps:
      - name: í—¬ìŠ¤ ì²´í¬
        run: |
          echo "í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ..."
          HEALTH_URL="https://${{ vars.WEB_PRODUCTION_DOMAIN }}/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/$MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ“ í—¬ìŠ¤ ì²´í¬ í†µê³¼"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "ì¬ì‹œë„ ëŒ€ê¸° ì¤‘... (${RETRY_DELAY}ì´ˆ)"
              sleep $RETRY_DELAY
            fi
          done
          echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
          exit 1

  verify-admin-production:
    name: Admin Production ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy-admin-production
    steps:
      - name: í—¬ìŠ¤ ì²´í¬
        run: |
          echo "í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ..."
          HEALTH_URL="https://${{ vars.ADMIN_PRODUCTION_DOMAIN }}/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/$MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ“ í—¬ìŠ¤ ì²´í¬ í†µê³¼"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "ì¬ì‹œë„ ëŒ€ê¸° ì¤‘... (${RETRY_DELAY}ì´ˆ)"
              sleep $RETRY_DELAY
            fi
          done
          echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
          exit 1

  notify-failure:
    name: ì‹¤íŒ¨ ì•Œë¦¼ ë° ë¡¤ë°± ê°€ì´ë“œ
    runs-on: ubuntu-latest
    needs: [build-production, deploy-web-production, deploy-admin-production, verify-web-production, verify-admin-production]
    if: failure()
    steps:
      - name: ì‹¤íŒ¨ ì •ë³´ ìˆ˜ì§‘
        id: failure-info
        run: |
          echo "WORKFLOW_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "DEPLOY_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: GitHub ì•Œë¦¼ (ê¸°ë³¸)
        run: |
          echo "::error::Production ë°°í¬ ì‹¤íŒ¨"
          echo "ì›Œí¬í”Œë¡œìš°: ${{ steps.failure-info.outputs.WORKFLOW_URL }}"
          echo "ì»¤ë°‹: ${{ steps.failure-info.outputs.COMMIT_SHA }}"
          echo "ë°°í¬ ë²„ì „: ${{ steps.failure-info.outputs.DEPLOY_VERSION }}"

      - name: ë¡¤ë°± ê°€ì´ë“œ ì¶œë ¥
        run: |
          echo "::warning::ë¡¤ë°± ê°€ì´ë“œ"
          echo ""
          echo "ìˆ˜ë™ ë¡¤ë°± ë°©ë²•:"
          echo "1. GitHub Actionsì—ì„œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹¤í–‰"
          echo "2. 'rollback' ì˜µì…˜ì„ trueë¡œ ì„¤ì •"
          echo "3. ë˜ëŠ” ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ìˆ˜ë™ ë¡¤ë°±:"
          echo ""
          echo "Web ì„œë²„:"
          echo "   ssh root@${{ secrets.WEB_PRODUCTION_HOST }}"
          echo "   cd /opt/workly/deployment/web"
          echo "   bash /opt/workly/scripts/rollback.sh web"
          echo ""
          echo "Admin ì„œë²„:"
          echo "   ssh root@${{ secrets.ADMIN_PRODUCTION_HOST }}"
          echo "   cd /opt/workly/deployment/admin"
          echo "   bash /opt/workly/scripts/rollback.sh admin"
