name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë°°í¬ ë²„ì „ (ì„ íƒì‚¬í•­)'
        required: false
        type: string
        default: 'latest'
      rollback:
        description: 'ë¡¤ë°± ëª¨ë“œ í™œì„±í™”'
        required: false
        type: boolean
        default: false
      skip-tests:
        description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸° (ê¸´ê¸‰ ë°°í¬ìš©)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  setup:
    name: í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ì„¤ì¹˜ í™•ì¸
        run: |
          node --version
          pnpm --version
          echo "í™˜ê²½ ì„¤ì • ì™„ë£Œ"
          echo "ë°°í¬ ë²„ì „: ${{ github.event.inputs.version }}"
          echo "ë¡¤ë°± ëª¨ë“œ: ${{ github.event.inputs.rollback }}"

  build-production:
    name: Production ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: setup
    env:
      NEXT_PUBLIC_ENV: production
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ ì „)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ ì „) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ì¡´ì¬"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
          else
            echo "âœ— .turbo ë””ë ‰í† ë¦¬ ì—†ìŒ (ì²« ì‹¤í–‰)"
          fi
          echo "=================================="

      - name: Production í™˜ê²½ ë¹Œë“œ
        run: pnpm turbo build
        env:
          NEXT_PUBLIC_ENV: production

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ í›„)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ í›„) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
            echo "ìºì‹œ í¬ê¸°: $(du -sh .turbo 2>/dev/null || echo 'N/A')"
          fi
          echo "=================================="

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦
        run: |
          echo "ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦ ì¤‘..."
          if [ -d "apps/web/.next" ]; then
            echo "âœ“ Web ì•± ë¹Œë“œ ì„±ê³µ"
          else
            echo "âœ— Web ì•± ë¹Œë“œ ì‹¤íŒ¨"
            exit 1
          fi

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: |
            apps/web/.next
            apps/web/public
            apps/web/package.json
          retention-days: 30

  build-docker-image:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: build-production
    permissions:
      contents: read
      packages: write
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GitHub Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/workly-web
          tags: |
            type=raw,value=production
            type=raw,value=latest
            type=sha,prefix=prod-
            type=raw,value=${{ github.event.inputs.version }},enable=${{ github.event.inputs.version != '' }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./apps/web/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_ENV=production

      - name: ì´ë¯¸ì§€ ì •ë³´ ì¶œë ¥
        run: |
          echo "ğŸ³ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ!"
          echo "Registry: ghcr.io"
          echo "Tags: ${{ steps.meta.outputs.tags }}"

  deploy-production:
    name: Production ì„œë²„ ë°°í¬
    runs-on: ubuntu-latest
    needs: build-docker-image
    environment:
      name: production
      url: https://worklyteam.cloud
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë¡¤ë°± ëª¨ë“œ í™•ì¸
        if: github.event.inputs.rollback == 'true'
        run: |
          echo "âš ï¸ ë¡¤ë°± ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤"

      - name: SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VULTR_WEB_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VULTR_WEB_HOST }} >> ~/.ssh/known_hosts

      - name: ë°°í¬ íŒŒì¼ ì „ì†¡
        if: github.event.inputs.rollback != 'true'
        run: |
          scp -r deployment/web/* root@${{ secrets.VULTR_WEB_HOST }}:/opt/workly/deployment/web/
          scp deployment/scripts/* root@${{ secrets.VULTR_WEB_HOST }}:/opt/workly/scripts/

      - name: Docker ì´ë¯¸ì§€ í’€ ë° ë°°í¬
        if: github.event.inputs.rollback != 'true'
        run: |
          ssh root@${{ secrets.VULTR_WEB_HOST }} << 'EOF'
            cd /opt/workly/deployment/web
            
            # GitHub Container Registry ë¡œê·¸ì¸
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            export DOCKER_IMAGE="ghcr.io/${{ github.repository }}/workly-web:production"
            export DEPLOY_ENV="production"
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            bash scripts/deploy-sequential.sh
          EOF

      - name: ë¡¤ë°± ì‹¤í–‰
        if: github.event.inputs.rollback == 'true'
        run: |
          ssh root@${{ secrets.VULTR_WEB_HOST }} << 'EOF'
            cd /opt/workly/deployment/web
            bash /opt/workly/scripts/rollback.sh web
          EOF

      - name: ë°°í¬ ì™„ë£Œ
        run: |
          echo "ğŸš€ Production ë°°í¬ ì™„ë£Œ!"
          echo "URL: https://worklyteam.cloud"
          echo "ë°°í¬ ë²„ì „: ${{ github.event.inputs.version }}"

  verify-production:
    name: Production ë°°í¬ ê²€ì¦
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: ë°°í¬ ì„±ê³µ í™•ì¸
        run: |
          echo "âœ“ Production ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ë°°í¬ í™˜ê²½: production"
          echo "ë°°í¬ ë²„ì „: ${{ github.event.inputs.version }}"

      - name: í—¬ìŠ¤ ì²´í¬
        run: |
          echo "í—¬ìŠ¤ ì²´í¬ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ..."
          HEALTH_URL="https://worklyteam.cloud/api/health"
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "í—¬ìŠ¤ ì²´í¬ ì‹œë„ $i/$MAX_RETRIES..."
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $HEALTH_URL || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ“ í—¬ìŠ¤ ì²´í¬ í†µê³¼"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "ì¬ì‹œë„ ëŒ€ê¸° ì¤‘... (${RETRY_DELAY}ì´ˆ)"
              sleep $RETRY_DELAY
            fi
          done
          echo "âš ï¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
          exit 1

      - name: ë°°í¬ ì™„ë£Œ ì•Œë¦¼
        run: |
          echo "::notice::Production ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
          echo "ë°°í¬ URL: https://worklyteam.cloud"

  notify-failure:
    name: ì‹¤íŒ¨ ì•Œë¦¼ ë° ë¡¤ë°± ê°€ì´ë“œ
    runs-on: ubuntu-latest
    needs: [build-production, deploy-production, verify-production]
    if: failure()
    steps:
      - name: ì‹¤íŒ¨ ì •ë³´ ìˆ˜ì§‘
        id: failure-info
        run: |
          echo "WORKFLOW_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "DEPLOY_VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: GitHub ì•Œë¦¼ (ê¸°ë³¸)
        run: |
          echo "::error::Production ë°°í¬ ì‹¤íŒ¨"
          echo "ì›Œí¬í”Œë¡œìš°: ${{ steps.failure-info.outputs.WORKFLOW_URL }}"
          echo "ì»¤ë°‹: ${{ steps.failure-info.outputs.COMMIT_SHA }}"
          echo "ë°°í¬ ë²„ì „: ${{ steps.failure-info.outputs.DEPLOY_VERSION }}"

      - name: ë¡¤ë°± ê°€ì´ë“œ ì¶œë ¥
        run: |
          echo "::warning::ë¡¤ë°± ê°€ì´ë“œ"
          echo ""
          echo "ìˆ˜ë™ ë¡¤ë°± ë°©ë²•:"
          echo "1. GitHub Actionsì—ì„œ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ë‹¤ì‹œ ì‹¤í–‰"
          echo "2. 'rollback' ì˜µì…˜ì„ trueë¡œ ì„¤ì •"
          echo "3. ë˜ëŠ” ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ìˆ˜ë™ ë¡¤ë°±:"
          echo "   ssh root@${{ secrets.VULTR_WEB_HOST }}"
          echo "   cd /opt/workly/deployment/web"
          echo "   bash /opt/workly/scripts/rollback.sh web"
          echo ""
          echo "ê¸´ê¸‰ ì—°ë½ì²˜:"
          echo "- DevOps íŒ€ì— ì¦‰ì‹œ ì—°ë½í•˜ì„¸ìš”"

      # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­ - SLACK_WEBHOOK_URL secret ì„¤ì • ì‹œ í™œì„±í™”)
      - name: Slack ì•Œë¦¼
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "ğŸš¨ Production ë°°í¬ ì‹¤íŒ¨",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš¨ Production ë°°í¬ ì‹¤íŒ¨*\nì›Œí¬í”Œë¡œìš°: <${{ steps.failure-info.outputs.WORKFLOW_URL }}|ì‹¤í–‰ ë¡œê·¸ ë³´ê¸°>\nì»¤ë°‹: `${{ steps.failure-info.outputs.COMMIT_SHA }}`\në°°í¬ ë²„ì „: `${{ steps.failure-info.outputs.DEPLOY_VERSION }}`\ní™˜ê²½: Production"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ë¡¤ë°± ë°©ë²•:*\n1. GitHub Actionsì—ì„œ ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ (rollback ì˜µì…˜ í™œì„±í™”)\n2. ì„œë²„ SSH ì ‘ì†í•˜ì—¬ ìˆ˜ë™ ë¡¤ë°±"
                  }
                }
              ]
            }
