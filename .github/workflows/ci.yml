name: CI

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    name: í™˜ê²½ ì„¤ì •
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ì„¤ì¹˜ í™•ì¸
        run: |
          node --version
          pnpm --version
          echo "í™˜ê²½ ì„¤ì • ì™„ë£Œ"

  lint:
    name: ì½”ë“œ ë¦°íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ESLint ì‹¤í–‰
        run: |
          START_TIME=$(date +%s)
          pnpm turbo lint
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Lint ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

  typecheck:
    name: íƒ€ì… ì²´í¬
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: TypeScript íƒ€ì… ì²´í¬ ì‹¤í–‰
        run: |
          START_TIME=$(date +%s)
          pnpm turbo typecheck
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Typecheck ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

  test:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ì»¤ë²„ë¦¬ì§€ í¬í•¨ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          START_TIME=$(date +%s)
          pnpm turbo test -- --coverage --run
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Test ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            **/coverage
          retention-days: 7

  e2e:
    name: E2E í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: pnpm exec playwright install --with-deps chromium

      - name: E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          START_TIME=$(date +%s)
          pnpm --filter web test:e2e
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

      - name: í…ŒìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            **/playwright-report
            **/test-results
          retention-days: 7

  build:
    name: ë¹Œë“œ
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ ì „)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ ì „) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ì¡´ì¬"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
            ls -lah .turbo/ || true
          else
            echo "âœ— .turbo ë””ë ‰í† ë¦¬ ì—†ìŒ (ì²« ì‹¤í–‰)"
          fi
          echo "=================================="

      - name: ì „ì²´ íŒ¨í‚¤ì§€ ë¹Œë“œ
        run: |
          START_TIME=$(date +%s)
          pnpm turbo build
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Build ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

      - name: Turborepo ìºì‹œ ìƒíƒœ í™•ì¸ (ë¹Œë“œ í›„)
        run: |
          echo "=== Turborepo ìºì‹œ ìƒíƒœ (ë¹Œë“œ í›„) ==="
          if [ -d ".turbo" ]; then
            echo "âœ“ .turbo ë””ë ‰í† ë¦¬ ìƒì„±ë¨"
            echo "ìºì‹œ íŒŒì¼ ìˆ˜: $(find .turbo -type f | wc -l)"
            echo "ìºì‹œ í¬ê¸°: $(du -sh .turbo 2>/dev/null || echo 'N/A')"
          fi
          echo "=================================="

      - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦
        run: |
          echo "ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ê²€ì¦ ì¤‘..."
          if [ -d "apps/web/.next" ]; then
            echo "âœ“ Web ì•± ë¹Œë“œ ì„±ê³µ"
          else
            echo "âœ— Web ì•± ë¹Œë“œ ì‹¤íŒ¨"
            exit 1
          fi

  security:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ë° ì˜ì¡´ì„± ì„¤ì •
        uses: ./.github/actions/setup
        with:
          node-version: '20'
          pnpm-version: '9.9.0'

      - name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” ì‹¤í–‰
        run: |
          echo "pnpm audit ì‹¤í–‰ ì¤‘..."
          START_TIME=$(date +%s)
          pnpm audit --audit-level=critical || {
            echo "Critical ì·¨ì•½ì  ë°œê²¬!"
            pnpm audit --json > audit-report.json
            exit 1
          }
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "â±ï¸ Security ìŠ¤ìº” ì‹¤í–‰ ì‹œê°„: ${DURATION}ì´ˆ"

      - name: ë³´ì•ˆ ìŠ¤ìº” ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: audit-report.json
          retention-days: 30

  report:
    name: ì‹¤í–‰ ì‹œê°„ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, e2e, build, security]
    if: always()
    steps:
      - name: ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œê°„ ìš”ì•½
        run: |
          echo "=== CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹œê°„ ìš”ì•½ ==="
          echo ""
          echo "ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ID: ${{ github.run_id }}"
          echo "ì›Œí¬í”Œë¡œìš° URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "Job ìƒíƒœ:"
          echo "  - Lint: ${{ needs.lint.result }}"
          echo "  - Typecheck: ${{ needs.typecheck.result }}"
          echo "  - Test: ${{ needs.test.result }}"
          echo "  - E2E: ${{ needs.e2e.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Security: ${{ needs.security.result }}"
          echo ""
          
          # ì „ì²´ ì„±ê³µ ì—¬ë¶€ í™•ì¸
          if [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.typecheck.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ] && \
             [ "${{ needs.e2e.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.security.result }}" == "success" ]; then
            echo "âœ… ëª¨ë“  ê²€ì¦ í†µê³¼!"
          else
            echo "âŒ ì¼ë¶€ ê²€ì¦ ì‹¤íŒ¨"
          fi
          
          echo ""
          echo "ğŸ’¡ ë³‘ë ¬ ì‹¤í–‰ ìµœì í™”:"
          echo "  - Lint, Typecheck, Test, E2E, Build, Security jobì´ ë³‘ë ¬ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤"
          echo "  - ì „ì²´ ì‹¤í–‰ ì‹œê°„ì€ ê°€ì¥ ê¸´ jobì˜ ì‹œê°„ê³¼ ë™ì¼í•©ë‹ˆë‹¤"
          echo "  - ìˆœì°¨ ì‹¤í–‰ ëŒ€ë¹„ ì•½ 5-6ë°° ë¹ ë¥¸ ì‹¤í–‰ ì‹œê°„"
          echo ""
          echo "ğŸ¯ ëª©í‘œ: ì „ì²´ CI ì‹¤í–‰ 10ë¶„ ì´ë‚´"
          echo ""
          echo "ğŸ“Š ìƒì„¸ íƒ€ì´ë°ì€ GitHub Actions UIì—ì„œ í™•ì¸í•˜ì„¸ìš”:"
          echo "   ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "=================================="

      - name: ì„±ëŠ¥ ê°œì„  ì œì•ˆ
        if: always()
        run: |
          echo "=== ì„±ëŠ¥ ìµœì í™” í˜„í™© ==="
          echo ""
          echo "âœ… ì ìš©ëœ ìµœì í™”:"
          echo "  âœ“ pnpm store ìºì‹± (pnpm-lock.yaml í•´ì‹œ ê¸°ë°˜)"
          echo "  âœ“ node_modules ìºì‹± (pnpm-lock.yaml í•´ì‹œ ê¸°ë°˜)"
          echo "  âœ“ Turborepo ìºì‹œ (commit SHA ê¸°ë°˜)"
          echo "  âœ“ ë³‘ë ¬ job ì‹¤í–‰ (6ê°œ job ë™ì‹œ ì‹¤í–‰)"
          echo "  âœ“ ìºì‹œ íˆíŠ¸ìœ¨ ëª¨ë‹ˆí„°ë§"
          echo "  âœ“ ì‹¤í–‰ ì‹œê°„ ì¸¡ì • ë° ë¡œê¹…"
          echo ""
          echo "ğŸ“ˆ ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ :"
          echo "  - ì²« ì‹¤í–‰: ~8-10ë¶„ (ìºì‹œ ì—†ìŒ)"
          echo "  - ìºì‹œ íˆíŠ¸: ~3-5ë¶„ (50-60% ë‹¨ì¶•)"
          echo "  - ë³‘ë ¬ ì‹¤í–‰: ìˆœì°¨ ëŒ€ë¹„ 5-6ë°° ë¹ ë¦„"
          echo ""
          echo "ğŸš€ ì¶”ê°€ ìµœì í™” ê°€ëŠ¥ í•­ëª©:"
          echo "  - Turborepo ì›ê²© ìºì‹œ (Vercel Remote Cache)"
          echo "  - í…ŒìŠ¤íŠ¸ ë³‘ë ¬í™” (Vitest workers, Playwright sharding)"
          echo "  - ì„ íƒì  job ì‹¤í–‰ (ë³€ê²½ëœ íŒ¨í‚¤ì§€ë§Œ í…ŒìŠ¤íŠ¸)"
          echo "  - Docker layer ìºì‹± (ì»¨í…Œì´ë„ˆ ì‚¬ìš© ì‹œ)"
          echo ""
          echo "ğŸ’¡ ìºì‹œ íš¨ìœ¨ì„± í™•ì¸:"
          echo "  - Setup action ë¡œê·¸ì—ì„œ ìºì‹œ íˆíŠ¸ìœ¨ í™•ì¸"
          echo "  - ìºì‹œ MISS ì‹œ pnpm-lock.yaml ë³€ê²½ ì—¬ë¶€ í™•ì¸"
          echo "  - Turborepo ìºì‹œ í¬ê¸° ë° íŒŒì¼ ìˆ˜ ëª¨ë‹ˆí„°ë§"
          echo "=================================="
